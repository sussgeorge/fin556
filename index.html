<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FIN556 â€“ DEX Dashboard (Hoodi Testnet)</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
    <style>
      body {
        font-family: Inter, system-ui, sans-serif;
        background: #f5f7fb;
        margin: 0;
      }
      header {
        background: #002b5b;
        color: #fff;
        text-align: center;
        padding: 20px 0;
        font-size: 1.3rem;
        font-weight: 600;
      }
      main {
        max-width: 1100px;
        margin: 30px auto;
        padding: 0 20px;
      }
      .card {
        background: #fff;
        border-radius: 10px;
        border: 1px solid #d0d7de;
        padding: 24px 28px;
        margin-bottom: 20px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
      }
      h3 {
        border-left: 4px solid #002b5b;
        padding-left: 10px;
        color: #002b5b;
      }
      button {
        background: #00509e;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 10px 18px;
        font-weight: 600;
        cursor: pointer;
      }
      button:hover {
        background: #003f7a;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        text-align: left;
        border-bottom: 1px solid #ddd;
        padding: 8px 10px;
      }
      th {
        color: #002b5b;
      }
      .info-box {
        background: #eef4fb;
        padding: 10px;
        border-radius: 6px;
      }
      .toast {
        position: fixed;
        right: 20px;
        bottom: 20px;
        background: #333;
        color: #fff;
        border-radius: 6px;
        padding: 12px 14px;
        display: none;
      }
      .row > * {
        margin-right: 6px;
      }
    </style>
  </head>
  <body>
    <header>FIN556 â€“ Decentralized Exchange Dashboard (Hoodi Testnet)</header>
    <main>
      <section class="card">
        <h3>Wallet Connection</h3>
        <button id="connectBtn">ðŸ”— Connect Wallet</button>
        <p>Wallet: <span id="walletAddr">Not connected</span></p>
        <p>Network: <span id="chainName">560048</span></p>
        <p>ETH Balance: <span id="ethBalance">â€“</span></p>
        <p>WETH Balance: <span id="wethBalance">â€“</span></p>
      </section>

      <section class="card">
        <h3>Team Tokens</h3>
        <table id="tokenTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Symbol</th>
              <th>Decimals</th>
              <th>Balance</th>
              <th>Address</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="card">
        <h3>Liquidity Pools</h3>
        <div id="poolList" class="info-box">No data loaded</div>
      </section>

      <section class="card">
        <h3>Trade Simulator</h3>
        <div class="row">
          <label>From</label
          ><select id="fromToken"></select>
          <input id="fromAmount" placeholder="Amount" />
          <label>To</label
          ><select id="toToken"></select>
          <input id="toAmount" placeholder="Estimated output" disabled />
          <label>Slippage (%)</label><input id="slippage" value="1" />
          <label>Deadline (mins)</label><input id="deadline" value="10" />
        </div>
        <div style="margin-top: 10px">
          <button id="quoteBtn">Get Quote</button>
          <button id="swapBtn">Execute Swap</button>
        </div>
      </section>
    </main>
    <div id="toast" class="toast"></div>

    <script>
      const HOODI = {
        chainIdDec: 560048,
        chainIdHex: "0x88BB0",
        rpc: "https://rpc.hoodi.ethpandaops.io",
      };
      const ADDR = {
        ROUTER: "0x5b491662E508c2E405500C8BF9d67E5dF780cD8e",
        FACTORY: "0x342D7aeC78cd3b581eb67655B6B7Bb157328590e",
        WETH: "0x7a1fd5C3185fe6261577AccEe220844Dc9026225",
      };
      const TOKEN_ADDRS = [
        "0x341aac04059a1e81e6390177c4e4d1992b422d84",
        "0x7Be129f76C4FC82752Dd1ddCCC154F2298e2a435",
        "0xC3c7E367D9047F8871ef553C02938189ca122f73",
        "0x97a47102478072710fBe2b2fE6c762b1F6cf2B06",
        "0x341dA74120EBFE04041F0D245cff62950ccfd64F",
      ];

      const ERC20_ABI = [
        "function name()view returns(string)",
        "function symbol()view returns(string)",
        "function decimals()view returns(uint8)",
        "function balanceOf(address)view returns(uint256)",
        "function allowance(address,address)view returns(uint256)",
        "function approve(address,uint256)returns(bool)",
      ];
      const PAIR_ABI = [
        "function token0()view returns(address)",
        "function token1()view returns(address)",
        "function getReserves()view returns(uint112,uint112,uint32)",
      ];
      const FACTORY_ABI = [
        "function allPairsLength()view returns(uint256)",
        "function allPairs(uint256) view returns(address)",
      ];
      const ROUTER_ABI = [
        "function getAmountsOut(uint amountIn,address[] calldata path)view returns(uint[] memory amounts)",
        "function swapExactTokensForTokens(uint,uint,address[] calldata,address,uint)returns(uint[] memory)",
        "function swapExactETHForTokens(uint,address[] calldata,address,uint)payable returns(uint[] memory)",
        "function swapExactTokensForETH(uint,uint,address[] calldata,address,uint)returns(uint[] memory)",
      ];

      let provider, signer, account;
      const rpcProvider = new ethers.JsonRpcProvider(HOODI.rpc);
      let tokenDetails = [];
      const $ = (id) => document.getElementById(id);
      function toast(msg, type = "info") {
        const t = $("toast");
        t.textContent = msg;
        t.style.background =
          type === "error"
            ? "#b91c1c"
            : type === "success"
            ? "#15803d"
            : "#333";
        t.style.display = "block";
        setTimeout(() => (t.style.display = "none"), 4000);
      }

      // Ensure network
      async function ensureHoodi() {
        if (!window.ethereum) return;
        const net = await provider.getNetwork();
        if (Number(net.chainId) === HOODI.chainIdDec) return;
        try {
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: HOODI.chainIdHex }],
          });
        } catch (e) {
          if (e.code === 4902) {
            await window.ethereum.request({
              method: "wallet_addEthereumChain",
              params: [
                {
                  chainId: HOODI.chainIdHex,
                  chainName: "Hoodi Testnet",
                  rpcUrls: [HOODI.rpc],
                  nativeCurrency: {
                    name: "Ether",
                    symbol: "ETH",
                    decimals: 18,
                  },
                },
              ],
            });
          } else throw e;
        }
      }

      // Connect wallet
      async function connect() {
        if (!window.ethereum) return toast("Please install MetaMask!", "error");
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        account = await signer.getAddress();
        $("walletAddr").textContent = account;
        await ensureHoodi();

        const bal = await provider.getBalance(account);
        $("ethBalance").textContent = `${ethers.formatEther(bal)} ETH`;

        try {
          const weth = new ethers.Contract(ADDR.WETH, ERC20_ABI, rpcProvider);
          const wethBal = await weth.balanceOf(account);
          $("wethBalance").textContent = `${ethers.formatUnits(
            wethBal,
            18
          )} WETH`;
        } catch {
          $("wethBalance").textContent = "Unavailable";
        }

        await loadTokens();
        const pairs = await fetchAllPairsFromFactory();
        await loadPools(pairs);
        await initTradeUI();
        toast("Wallet connected!", "success");
      }

      // Load team tokens
      async function loadTokens() {
        const tbody = $("tokenTable").querySelector("tbody");
        tbody.innerHTML = "";
        tokenDetails = [];
        for (const addr of TOKEN_ADDRS) {
          try {
            const c = new ethers.Contract(addr, ERC20_ABI, rpcProvider);
            const [name, symbol, decimals, bal] = await Promise.all([
              c.name(),
              c.symbol(),
              c.decimals(),
              c.balanceOf(account),
            ]);
            tokenDetails.push({ name, symbol, decimals, address: addr });
            tbody.insertAdjacentHTML(
              "beforeend",
              `<tr><td>${name}</td><td>${symbol}</td><td>${decimals}</td><td>${ethers.formatUnits(
                bal,
                decimals
              )}</td><td>${addr}</td></tr>`
            );
          } catch (e) {
            console.error("Token load error:", addr, e);
          }
        }
      }

      // Fetch pairs from factory
      async function fetchAllPairsFromFactory() {
        try {
          const factory = new ethers.Contract(
            ADDR.FACTORY,
            FACTORY_ABI,
            rpcProvider
          );
          const len = await factory.allPairsLength();
          console.log("Total pairs:", len.toString());
          const pairs = [];
          for (let i = 0; i < Number(len) && i < 10; i++) {
            const addr = await factory.allPairs(i);
            pairs.push(addr);
          }
          console.log("Pairs:", pairs);
          return pairs;
        } catch (e) {
          console.error("Factory fetch error:", e);
          toast("Could not fetch pairs from factory", "error");
          return [];
        }
      }

      // Load pools
      async function loadPools(pairList) {
        const div = $("poolList");
        div.textContent = "Loading liquidity pools...";
        let html = "";
        for (const addr of pairList) {
          try {
            const pair = new ethers.Contract(addr, PAIR_ABI, rpcProvider);
            const [t0, t1] = await Promise.all([pair.token0(), pair.token1()]);
            const [r0, r1] = await pair.getReserves();
            const c0 = new ethers.Contract(t0, ERC20_ABI, rpcProvider);
            const c1 = new ethers.Contract(t1, ERC20_ABI, rpcProvider);
            const [s0, s1, d0, d1] = await Promise.all([
              c0.symbol(),
              c1.symbol(),
              c0.decimals(),
              c1.decimals(),
            ]);
            const R0 = Number(ethers.formatUnits(r0, d0)),
              R1 = Number(ethers.formatUnits(r1, d1));
            const p0to1 = R1 / R0,
              p1to0 = R0 / R1;
            let p0eth = "-",
              p1eth = "-";
            if (t0.toLowerCase() === ADDR.WETH.toLowerCase())
              p1eth = p0to1.toFixed(6);
            else if (t1.toLowerCase() === ADDR.WETH.toLowerCase())
              p0eth = p1to0.toFixed(6);
            html += `<div style="margin-bottom:8px">
     <b>${s0}/${s1}</b><br>
     Reserves: ${R0.toFixed(4)} ${s0} / ${R1.toFixed(4)} ${s1}<br>
     Price ${s0}â†’${s1}: ${p0to1.toFixed(6)} | ${s1}â†’${s0}: ${p1to0.toFixed(
              6
            )}<br>
     Derived: ${s0}â†’ETH: ${p0eth} | ${s1}â†’ETH: ${p1eth}
   </div><hr>`;
          } catch (e) {
            console.error("Pool error:", addr, e);
          }
        }
        div.innerHTML = html || "No data loaded (verify pair addresses)";
      }

      // Populate Trade UI
      async function initTradeUI() {
        const from = $("fromToken"),
          to = $("toToken");
        const opts = [
          `<option value="ETH">ETH</option>`,
          ...tokenDetails.map(
            (t) => `<option value="${t.address}">${t.symbol}</option>`
          ),
        ];
        from.innerHTML = opts.join("");
        to.innerHTML = opts.join("");
      }

      // Quote and swap
      async function getQuote() {
        try {
          const router = new ethers.Contract(
            ADDR.ROUTER,
            ROUTER_ABI,
            rpcProvider
          );
          const from = $("fromToken").value,
            to = $("toToken").value,
            amt = $("fromAmount").value;
          if (!amt) return toast("Enter amount", "error");
          const fromMeta =
            from === "ETH"
              ? { decimals: 18 }
              : tokenDetails.find((t) => t.address === from);
          const path =
            from === "ETH"
              ? [ADDR.WETH, to]
              : to === "ETH"
              ? [from, ADDR.WETH]
              : [from, ADDR.WETH, to];
          const amounts = await router.getAmountsOut(
            ethers.parseUnits(amt, fromMeta.decimals),
            path
          );
          const outMeta =
            to === "ETH"
              ? { decimals: 18 }
              : tokenDetails.find((t) => t.address === to);
          const est = ethers.formatUnits(amounts.at(-1), outMeta.decimals);
          $("toAmount").value = est;
          toast(`Estimated output: ${est}`, "success");
        } catch (e) {
          console.error(e);
          toast("Quote failed", "error");
        }
      }

      async function ensureApproval(token, owner, spender, amt) {
        const c = new ethers.Contract(token, ERC20_ABI, signer);
        const allowance = await c.allowance(owner, spender);
        if (allowance >= amt) return;
        const tx = await c.approve(spender, ethers.MaxUint256);
        await tx.wait();
        toast("Token approved", "success");
      }

      async function executeSwap() {
        try {
          const router = new ethers.Contract(ADDR.ROUTER, ROUTER_ABI, signer);
          const from = $("fromToken").value,
            to = $("toToken").value,
            amtIn = $("fromAmount").value;
          const slippage = parseFloat($("slippage").value),
            deadlineMins = parseInt($("deadline").value);
          if (!amtIn) return toast("Enter amount", "error");
          const fromMeta =
            from === "ETH"
              ? { decimals: 18 }
              : tokenDetails.find((t) => t.address === from);
          const path =
            from === "ETH"
              ? [ADDR.WETH, to]
              : to === "ETH"
              ? [from, ADDR.WETH]
              : [from, ADDR.WETH, to];
          const amounts = await router.getAmountsOut(
            ethers.parseUnits(amtIn, fromMeta.decimals),
            path
          );
          const amtOutMin = (amounts.at(-1) * BigInt(100 - slippage)) / 100n;
          const deadline = Math.floor(Date.now() / 1000) + deadlineMins * 60;
          let tx;
          if (from === "ETH") {
            tx = await router.swapExactETHForTokens(
              amtOutMin,
              path,
              account,
              deadline,
              { value: ethers.parseUnits(amtIn, 18) }
            );
          } else if (to === "ETH") {
            await ensureApproval(
              from,
              account,
              ADDR.ROUTER,
              ethers.parseUnits(amtIn, fromMeta.decimals)
            );
            tx = await router.swapExactTokensForETH(
              ethers.parseUnits(amtIn, fromMeta.decimals),
              amtOutMin,
              path,
              account,
              deadline
            );
          } else {
            await ensureApproval(
              from,
              account,
              ADDR.ROUTER,
              ethers.parseUnits(amtIn, fromMeta.decimals)
            );
            tx = await router.swapExactTokensForTokens(
              ethers.parseUnits(amtIn, fromMeta.decimals),
              amtOutMin,
              path,
              account,
              deadline
            );
          }
          toast("Swap submitted", "success");
          await tx.wait();
          toast("Swap executed", "success");
        } catch (e) {
          console.error(e);
          toast("Swap failed", "error");
        }
      }

      $("connectBtn").onclick = connect;
      $("quoteBtn").onclick = getQuote;
      $("swapBtn").onclick = executeSwap;
    </script>
  </body>
</html>
