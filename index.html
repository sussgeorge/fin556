<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FIN556 DEX ‚Äì Hoodi Testnet</title>
    <style>
      :root {
        --bg: #0f1320;
        --card: #151a2b;
        --muted: #8ea0c0;
        --accent: #7bd88f;
        --warn: #f7c948;
        --error: #ff6b6b;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: #fff;
        font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto,
          "Helvetica Neue", Arial;
      }
      .wrap {
        max-width: 1100px;
        margin: 24px auto;
        padding: 0 16px;
      }
      .row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }
      .card {
        background: var(--card);
        border: 1px solid #22283d;
        border-radius: 14px;
        padding: 16px;
        flex: 1;
        min-width: 290px;
      }
      .muted {
        color: var(--muted);
      }
      .accent {
        color: var(--accent);
      }
      .warn {
        color: var(--warn);
      }
      .error {
        color: var(--error);
      }
      button {
        background: #26304d;
        border: 1px solid #2d385a;
        color: #fff;
        border-radius: 10px;
        padding: 10px 14px;
        cursor: pointer;
      }
      button:hover {
        filter: brightness(1.05);
      }
      input,
      select {
        width: 100%;
        background: #0f1320;
        border: 1px solid #2d385a;
        color: #fff;
        border-radius: 10px;
        padding: 10px;
      }
      .grid {
        display: grid;
        gap: 10px;
      }
      .grid2 {
        grid-template-columns: 1fr 1fr;
      }
      .pill {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        background: #1f2742;
        border: 1px solid #2d385a;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }
      .hr {
        height: 1px;
        background: #232a46;
        margin: 12px 0;
      }
      a {
        color: #a6c8ff;
      }
      .toast {
        position: fixed;
        right: 12px;
        bottom: 12px;
        max-width: 420px;
        background: #10162b;
        border: 1px solid #23315c;
        border-radius: 14px;
        padding: 12px 14px;
        display: none;
      }
      .right {
        margin-left: 6px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  </head>
  <body>
    <div class="wrap">
      <h2>FIN556 ‚Äì Hoodi Testnet DEX</h2>
      <div class="muted">
        Connect your wallet and view team tokens, pools & trade via UniswapV2.
      </div>

      <!-- Wallet -->
      <div class="row" style="margin-top: 14px">
        <div class="card">
          <div
            class="row"
            style="align-items: center; justify-content: space-between"
          >
            <div>
              <div class="muted">Wallet</div>
              <div id="acc" class="mono">Not connected</div>
            </div>
            <div>
              <button id="btnConnect">Connect</button>
              <button id="btnSwitch" class="right">Switch to Hoodi</button>
            </div>
          </div>
          <div class="hr"></div>
          <div class="row">
            <div class="card" style="flex: 1">
              <div class="muted">Chain</div>
              <div id="chain" class="mono">‚Äì</div>
              <div
                id="chainWarn"
                class="warn"
                style="margin-top: 6px; display: none"
              >
                Not on Hoodi (560048). Click ‚ÄúSwitch to Hoodi‚Äù.
              </div>
            </div>
            <div class="card" style="flex: 1">
              <div class="muted">Native Balance</div>
              <div id="ethBal" class="mono">‚Äì</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tokens -->
      <div class="row" style="margin-top: 14px">
        <div class="card">
          <h3>Team Tokens</h3>
          <div id="tokenList" class="grid"></div>
        </div>
      </div>

      <!-- Pools -->
      <div class="row" style="margin-top: 14px">
        <div class="card">
          <h3>Liquidity Pools</h3>
          <div id="pairList" class="grid"></div>
        </div>
      </div>

      <!-- Trade -->
      <div class="row" style="margin-top: 14px">
        <div class="card">
          <h3>Trade</h3>
          <div class="grid">
            <div>
              <div class="muted">From</div>
              <select id="fromToken"></select>
              <input id="fromAmount" placeholder="Amount" />
            </div>
            <div>
              <div class="muted">To</div>
              <select id="toToken"></select>
              <input id="toAmount" placeholder="Estimated output" disabled />
            </div>
            <div class="grid grid2">
              <div>
                <div class="muted">Slippage %</div>
                <input id="slippage" value="1" />
              </div>
              <div>
                <div class="muted">Deadline (mins)</div>
                <input id="deadlineMins" value="10" />
              </div>
            </div>
            <div class="row" style="justify-content: flex-end">
              <button id="btnQuote">Get Quote</button>
              <button id="btnSwap" class="right">Swap</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
      // ------- Network / Addresses -------
      const HOODI = {
        chainIdDec: 560048,
        chainIdHex: "0x88BB0",
        rpc: "https://rpc.hoodi.ethpandaops.io",
        explorer: "https://hoodi.etherscan.io",
      };

      const ADDR = {
        ROUTER: "0x5b491662E508c2E405500C8BF9d67E5dF780cD8e",
        FACTORY: "0x342D7aeC78cd3b581eb67655B6B7Bb157328590e",
        WETH: "0x7a1fd5C3185fe6261577AccEe220844Dc9026225",
      };

      // üëâ Add ALL team Q1 tokens here
      const TOKENS = [
        {
          name: "HoodiToken",
          symbol: "HOODI",
          address: "0x341aac04059a1e81e6390177c4e4d1992b422d84",
        },
        // { name: "TeammateToken", symbol: "TT", address: "0x..." },
      ];

      // ------- ABIs -------
      const ERC20_ABI = [
        "function name() view returns (string)",
        "function symbol() view returns (string)",
        "function decimals() view returns (uint8)",
        "function balanceOf(address) view returns (uint256)",
        "function allowance(address,address) view returns (uint256)",
        "function approve(address,uint256) returns (bool)",
      ];
      const PAIR_ABI = [
        "function token0() view returns (address)",
        "function token1() view returns (address)",
        "function getReserves() view returns (uint112,uint112,uint32)",
      ];
      const ROUTER_ABI = [
        "function getAmountsOut(uint amountIn, address[] path) view returns (uint[] amounts)",
        "function swapExactETHForTokens(uint amountOutMin, address[] path, address to, uint deadline) payable returns (uint[] amounts)",
        "function swapExactTokensForETH(uint amountIn, uint amountOutMin, address[] path, address to, uint deadline) returns (uint[] amounts)",
        "function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] path, address to, uint deadline) returns (uint[] amounts)",
      ];

      // ------- UI helpers -------
      let provider, signer, account;
      const el = (id) => document.getElementById(id);
      function toast(msg, type = "info") {
        const t = el("toast");
        t.style.display = "block";
        t.style.borderColor =
          type === "error"
            ? "#7a1f2b"
            : type === "warn"
            ? "#7a6a1f"
            : "#23315c";
        t.textContent = msg;
        setTimeout(() => (t.style.display = "none"), 5000);
      }
      function fmt(x, d = 4) {
        return Number(x).toLocaleString(undefined, {
          maximumFractionDigits: d,
        });
      }

      // ------- Wallet / Network -------
      async function connect() {
        if (!window.ethereum) return toast("Install MetaMask.", "warn");
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        account = await signer.getAddress();
        el("acc").textContent = account;
        await ensureNetwork();
        await postConnect();
      }
      async function ensureNetwork() {
        const net = await provider.getNetwork();
        el("chain").textContent = `${net.chainId}`;
        const ok = Number(net.chainId) === HOODI.chainIdDec;
        el("chainWarn").style.display = ok ? "none" : "block";
        if (!ok) await switchToHoodi();
      }
      async function switchToHoodi() {
        if (!window.ethereum) return;
        try {
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: HOODI.chainIdHex }],
          });
        } catch (e) {
          if (e.code === 4902) {
            await window.ethereum.request({
              method: "wallet_addEthereumChain",
              params: [
                {
                  chainId: HOODI.chainIdHex,
                  chainName: "Hoodi Testnet",
                  rpcUrls: [HOODI.rpc],
                  nativeCurrency: {
                    name: "Ether",
                    symbol: "ETH",
                    decimals: 18,
                  },
                  blockExplorerUrls: [HOODI.explorer],
                },
              ],
            });
          } else toast(`Switch failed: ${e.message}`, "error");
        }
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        await postConnect();
      }
      async function postConnect() {
        const bal = await provider.getBalance(account);
        el("ethBal").textContent = `${fmt(ethers.formatEther(bal))} ETH`;
        await renderTokens();
        await renderPairs();
        await initTradeUI();
        setInterval(() => renderPairs(), 20000);
      }

      // ------- Tokens / Pairs -------
      async function renderTokens() {
        const holder = el("tokenList");
        holder.innerHTML = "";
        for (const t of TOKENS) {
          try {
            const c = new ethers.Contract(t.address, ERC20_ABI, signer);
            const [sym, dec, bal] = await Promise.all([
              c.symbol(),
              c.decimals(),
              c.balanceOf(account),
            ]);
            const fmtBal = ethers.formatUnits(bal || 0n, dec);
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <div class="row" style="justify-content:space-between">
                <div><b>${t.name}</b> <span class="muted">(${sym})</span></div>
                <div class="pill mono"><a href="${HOODI.explorer}/address/${
              t.address
            }" target="_blank">${t.address.slice(0, 8)}‚Ä¶${t.address.slice(
              -6
            )}</a></div>
              </div>
              <div class="hr"></div>
              <div class="row">
                <div><span class="muted">Decimals:</span> ${dec}</div>
                <div><span class="muted">Your balance:</span> ${fmt(
                  fmtBal
                )}</div>
              </div>`;
            holder.appendChild(card);
            t.decimals = dec;
            t.symbol = sym;
          } catch (e) {
            toast(`Token load failed: ${t.address} ‚Äì ${e.message}`, "error");
          }
        }
      }

      async function fetchPairs() {
        const factory = new ethers.Contract(
          ADDR.FACTORY,
          ["function getPair(address,address) view returns (address)"],
          signer
        );
        const pairs = [];
        for (const t of TOKENS) {
          const pairAddress = await factory.getPair(t.address, ADDR.WETH);
          if (pairAddress !== ethers.ZeroAddress)
            pairs.push({ address: pairAddress });
        }
        return pairs;
      }

      async function renderPairs() {
        const holder = el("pairList");
        holder.innerHTML = "";
        const PAIRS = await fetchPairs();
        if (PAIRS.length === 0) {
          holder.innerHTML = `<div class="muted">No active pools found. Add liquidity first.</div>`;
          return;
        }

        for (const p of PAIRS) {
          try {
            const pair = new ethers.Contract(p.address, PAIR_ABI, signer);
            const [t0, t1, res] = await Promise.all([
              pair.token0(),
              pair.token1(),
              pair.getReserves(),
            ]);
            const r0 = Number(res[0]);
            const r1 = Number(res[1]);
            if (r0 === 0 && r1 === 0) continue;

            const token0 = TOKENS.find(
              (x) => x.address.toLowerCase() === t0.toLowerCase()
            ) || { symbol: "WETH" };
            const token1 = TOKENS.find(
              (x) => x.address.toLowerCase() === t1.toLowerCase()
            ) || { symbol: "WETH" };
            const p0in1 = r0 > 0 ? r1 / r0 : 0;
            const p1in0 = r1 > 0 ? r0 / r1 : 0;

            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <div class="row" style="justify-content:space-between">
                <div><b>Pair</b></div>
                <div class="pill mono"><a href="${HOODI.explorer}/address/${
              p.address
            }" target="_blank">${p.address.slice(0, 8)}‚Ä¶${p.address.slice(
              -6
            )}</a></div>
              </div>
              <div class="hr"></div>
              <div class="grid grid2">
                <div><div class="muted">token0</div><div class="mono">${
                  token0.symbol
                }</div><div class="muted">reserve0</div><div class="mono">${fmt(
              r0
            )}</div></div>
                <div><div class="muted">token1</div><div class="mono">${
                  token1.symbol
                }</div><div class="muted">reserve1</div><div class="mono">${fmt(
              r1
            )}</div></div>
              </div>
              <div class="hr"></div>
              <div class="mono">${token0.symbol} ‚Üí ${token1.symbol}: ${fmt(
              p0in1,
              8
            )}</div>
              <div class="mono">${token1.symbol} ‚Üí ${token0.symbol}: ${fmt(
              p1in0,
              8
            )}</div>`;
            holder.appendChild(card);
          } catch (e) {
            console.warn(`Skipping bad pair ${p.address}: ${e.message}`);
          }
        }
      }

      // ------- Trade / Router -------
      const router = () => new ethers.Contract(ADDR.ROUTER, ROUTER_ABI, signer);

      function allAssets() {
        const ETH = {
          name: "Ether",
          symbol: "ETH",
          address: "ETH",
          decimals: 18,
        };
        return [ETH, ...TOKENS];
      }
      function byAddress(addr) {
        if (addr === "ETH")
          return { symbol: "ETH", decimals: 18, address: "ETH" };
        return TOKENS.find(
          (t) => t.address.toLowerCase() === addr.toLowerCase()
        );
      }
      function pathForSwap(fromAddr, toAddr) {
        const isFromETH = fromAddr === "ETH";
        const isToETH = toAddr === "ETH";
        if (isFromETH && !isToETH) return [ADDR.WETH, toAddr];
        if (!isFromETH && isToETH) return [fromAddr, ADDR.WETH];
        if (!isFromETH && !isToETH) return [fromAddr, ADDR.WETH, toAddr];
        throw new Error("ETH‚ÜíETH is not a swap.");
      }
      function minutesFromNow(mins) {
        return Math.floor(Date.now() / 1000) + Number(mins || 10) * 60;
      }

      async function initTradeUI() {
        const list = allAssets(),
          fromSel = el("fromToken"),
          toSel = el("toToken");
        fromSel.innerHTML = "";
        toSel.innerHTML = "";
        for (const a of list) {
          const mk = (x) => {
            const o = document.createElement("option");
            o.value = a.address;
            o.textContent = a.symbol;
            return o;
          };
          fromSel.appendChild(mk());
          toSel.appendChild(mk());
        }
        fromSel.value = "ETH";
        if (TOKENS[0]) toSel.value = TOKENS[0].address;
        el("btnQuote").onclick = quoteSwap;
        el("btnSwap").onclick = doSwap;
      }

      async function quoteSwap() {
        try {
          const fromAddr = el("fromToken").value,
            toAddr = el("toToken").value;
          if (fromAddr === toAddr)
            return toast("Choose different assets.", "warn");
          const amt = el("fromAmount").value;
          if (!amt || Number(amt) <= 0)
            return toast("Enter an amount.", "warn");
          const fromMeta = byAddress(fromAddr);
          const amountIn = ethers.parseUnits(amt, fromMeta.decimals ?? 18);
          const p = pathForSwap(fromAddr, toAddr);
          const amounts = await router().getAmountsOut(amountIn, p);
          const outMeta = byAddress(toAddr);
          el("toAmount").value = ethers.formatUnits(
            amounts[amounts.length - 1],
            outMeta.decimals ?? 18
          );
        } catch (e) {
          toast(`Quote failed: ${e.message}`, "error");
        }
      }

      async function ensureApproval(tokenAddr, owner, spender, minAmount) {
        const erc = new ethers.Contract(tokenAddr, ERC20_ABI, signer);
        const current = await erc.allowance(owner, spender);
        if (current >= minAmount) return true;
        const tx = await erc.approve(spender, minAmount);
        toast(`Approve pending: ${tx.hash}`);
        await tx.wait();
        toast("Approval confirmed");
        return true;
      }

      async function doSwap() {
        try {
          const fromAddr = el("fromToken").value,
            toAddr = el("toToken").value;
          const slippage = Math.max(0, Number(el("slippage").value || 1));
          const deadline = minutesFromNow(el("deadlineMins").value || 10);
          if (fromAddr === toAddr)
            return toast("Choose different assets.", "warn");

          const fromMeta = byAddress(fromAddr),
            toMeta = byAddress(toAddr);
          const amountIn = ethers.parseUnits(
            el("fromAmount").value || "0",
            fromMeta.decimals ?? 18
          );
          if (amountIn <= 0n) return toast("Enter a valid amount.", "warn");

          const p = pathForSwap(fromAddr, toAddr);
          const amounts = await router().getAmountsOut(amountIn, p);
          const out = amounts[amounts.length - 1];
          const outMin =
            out - (out * BigInt(Math.floor(slippage * 100))) / 10000n;

          let tx;
          if (fromAddr === "ETH") {
            tx = await router().swapExactETHForTokens(
              outMin,
              p,
              account,
              deadline,
              { value: amountIn }
            );
          } else if (toAddr === "ETH") {
            await ensureApproval(fromAddr, account, ADDR.ROUTER, amountIn);
            tx = await router().swapExactTokensForETH(
              amountIn,
              outMin,
              p,
              account,
              deadline
            );
          } else {
            await ensureApproval(fromAddr, account, ADDR.ROUTER, amountIn);
            tx = await router().swapExactTokensForTokens(
              amountIn,
              outMin,
              p,
              account,
              deadline
            );
          }
          toast(`Swap pending: ${tx.hash}`);
          const rc = await tx.wait();
          toast(`Swap success in block ${rc.blockNumber}`);
          await renderTokens();
          await renderPairs();
        } catch (e) {
          const msg = (
            e?.reason ||
            e?.data?.message ||
            e?.message ||
            ""
          ).toLowerCase();
          if (msg.includes("insufficient"))
            toast("Insufficient balance or allowance.", "error");
          else if (msg.includes("exp") || msg.includes("deadline"))
            toast("Deadline exceeded. Increase deadline.", "error");
          else if (msg.includes("slippage") || msg.includes("k"))
            toast(
              "Slippage exceeded. Try higher slippage or smaller trade.",
              "error"
            );
          else toast(`Swap failed: ${e.message}`, "error");
        }
      }

      // ------- Bindings -------
      el("btnConnect").onclick = connect;
      el("btnSwitch").onclick = switchToHoodi;
    </script>
  </body>
</html>
