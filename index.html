<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FIN556 â€“ Decentralized Exchange Dashboard (Hoodi Testnet)</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
    <style>
      body {
        font-family: Inter, system-ui, sans-serif;
        background: #f5f7fb;
        margin: 0;
      }
      header {
        background: #002b5b;
        color: #fff;
        text-align: center;
        padding: 20px 0;
        font-size: 1.3rem;
        font-weight: 600;
      }
      main {
        max-width: 1100px;
        margin: 30px auto;
        padding: 0 20px;
      }
      .card {
        background: #fff;
        border-radius: 10px;
        border: 1px solid #d0d7de;
        padding: 24px 28px;
        margin-bottom: 20px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
      }
      h3 {
        border-left: 4px solid #002b5b;
        padding-left: 10px;
        color: #002b5b;
      }
      button {
        background: #00509e;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 10px 18px;
        font-weight: 600;
        cursor: pointer;
      }
      button:hover {
        background: #003f7a;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      th,
      td {
        text-align: left;
        border-bottom: 1px solid #ddd;
        padding: 8px 10px;
      }
      th {
        color: #002b5b;
        font-weight: 600;
      }
      .info-box {
        background: #eef4fb;
        padding: 10px;
        border-radius: 6px;
      }
      .toast {
        position: fixed;
        right: 20px;
        bottom: 20px;
        background: #333;
        color: #fff;
        border-radius: 6px;
        padding: 12px 14px;
        display: none;
      }
      .row > * {
        margin-right: 6px;
      }
      input,
      select {
        height: 36px;
      }
      #toAmount[disabled] {
        background: #f4f6fa;
      }
    </style>
  </head>

  <body>
    <header>FIN556 â€“ Decentralized Exchange Dashboard (Hoodi Testnet)</header>

    <main>
      <!-- WALLET SECTION -->
      <section class="card">
        <h3>Wallet Connection</h3>
        <button id="connectBtn">ðŸ”— Connect Wallet</button>
        <p>Wallet: <span id="walletAddr">Not connected</span></p>
        <p>Network: <span id="chainName">â€“</span></p>
        <p>ETH Balance: <span id="ethBalance">â€“</span></p>
      </section>

      <!-- TOKENS -->
      <section class="card">
        <h3>Team Tokens</h3>
        <table id="tokenTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Symbol</th>
              <th>Decimals</th>
              <th>Balance</th>
              <th>Address</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- LIQUIDITY POOLS -->
      <section class="card">
        <h3>Liquidity Pools</h3>
        <div id="poolList" class="info-box">No data loaded</div>
      </section>

      <!-- TRADE -->
      <section class="card">
        <h3>Trade Simulator</h3>
        <div class="row">
          <label>From Token</label>
          <select id="fromToken"></select>
          <input id="fromAmount" placeholder="Amount" />
          <label>To Token</label>
          <select id="toToken"></select>
          <input id="toAmount" placeholder="Estimated output" disabled />
          <label>Slippage (%)</label>
          <input id="slippage" value="1" />
          <label>Deadline (mins)</label>
          <input id="deadline" value="10" />
        </div>
        <div style="margin-top: 10px">
          <button id="quoteBtn">Get Quote</button>
          <button id="swapBtn">Execute Swap</button>
        </div>
      </section>
    </main>

    <div id="toast" class="toast"></div>

    <script>
      // --------- Network & addresses ----------
      const HOODI = {
        chainIdDec: 560048,
        chainIdHex: "0x88BB0",
        rpc: "https://rpc.hoodi.ethpandaops.io",
        explorer: "https://hoodi.etherscan.io",
      };

      const ADDR = {
        ROUTER: "0x5b491662E508c2E405500C8BF9d67E5dF780cD8e",
        FACTORY: "0x342D7aeC78cd3b581eb67655B6B7Bb157328590e",
        WETH: "0x7a1fd5C3185fe6261577AccEe220844Dc9026225",
      };

      const TOKEN_ADDRS = [
        "0x341aac04059a1e81e6390177c4e4d1992b422d84", // HOODI
        "0x7Be129f76C4FC82752Dd1ddCCC154F2298e2a435", // XLZD2
        "0xC3c7E367D9047F8871ef553C02938189ca122f73", // SToken-A
        "0x97a47102478072710fBe2b2fE6c762b1F6cf2B06", // TTK
        "0x341dA74120EBFE04041F0D245cff62950ccfd64F", // C-K-H
      ];

      // --------- ABIs ----------
      const ERC20_ABI = [
        "function name() view returns (string)",
        "function symbol() view returns (string)",
        "function decimals() view returns (uint8)",
        "function balanceOf(address) view returns (uint256)",
        "function allowance(address, address) view returns (uint256)",
        "function approve(address, uint256) returns (bool)",
      ];

      const PAIR_ABI = [
        "function token0() view returns (address)",
        "function token1() view returns (address)",
        "function getReserves() view returns (uint112,uint112,uint32)",
      ];

      const ROUTER_ABI = [
        "function getAmountsOut(uint amountIn, address[] calldata path) external view returns (uint[] memory amounts)",
        "function swapExactTokensForTokens(uint amountIn,uint amountOutMin,address[] calldata path,address to,uint deadline) external returns (uint[] memory amounts)",
        "function swapExactETHForTokens(uint amountOutMin,address[] calldata path,address to,uint deadline) payable external returns (uint[] memory amounts)",
        "function swapExactTokensForETH(uint amountIn,uint amountOutMin,address[] calldata path,address to,uint deadline) external returns (uint[] memory amounts)",
      ];

      // --------- State ----------
      let provider, signer, account;
      const rpcProvider = new ethers.JsonRpcProvider(HOODI.rpc);
      let tokenDetails = [];

      // --------- Utils ----------
      const $ = (id) => document.getElementById(id);
      function toast(msg, type = "info") {
        const el = $("toast");
        el.textContent = msg;
        el.style.background =
          type === "error"
            ? "#b91c1c"
            : type === "success"
            ? "#15803d"
            : "#333";
        el.style.display = "block";
        setTimeout(() => (el.style.display = "none"), 3500);
      }

      function symbolOf(addr) {
        const t = tokenDetails.find(
          (x) => x.address.toLowerCase() === (addr || "").toLowerCase()
        );
        return t ? t.symbol : addr ? addr.slice(0, 6) : "?";
      }

      function metaFor(addr) {
        if (addr === "ETH")
          return { symbol: "ETH", address: "ETH", decimals: 18 };
        return tokenDetails.find(
          (t) => t.address.toLowerCase() === addr.toLowerCase()
        );
      }

      function buildPath(from, to) {
        // Route via WETH for all non-ETH â†” non-ETH swaps
        if (from === "ETH" && to !== "ETH") return [ADDR.WETH, to];
        if (from !== "ETH" && to === "ETH") return [from, ADDR.WETH];
        if (from !== "ETH" && to !== "ETH") return [from, ADDR.WETH, to];
        throw new Error("ETHâ†’ETH swap is not valid");
      }

      async function ensureHoodi() {
        if (!window.ethereum) return;
        const net = await provider.getNetwork();
        if (Number(net.chainId) === HOODI.chainIdDec) return;
        try {
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: HOODI.chainIdHex }],
          });
        } catch (e) {
          if (e.code === 4902) {
            await window.ethereum.request({
              method: "wallet_addEthereumChain",
              params: [
                {
                  chainId: HOODI.chainIdHex,
                  chainName: "Hoodi Testnet",
                  rpcUrls: [HOODI.rpc],
                  nativeCurrency: {
                    name: "Ether",
                    symbol: "ETH",
                    decimals: 18,
                  },
                  blockExplorerUrls: [HOODI.explorer],
                },
              ],
            });
          } else {
            throw e;
          }
        }
      }

      // ------------------------------ CONNECT WALLET ------------------------------
      async function connect() {
        if (!window.ethereum) return toast("Please install MetaMask!", "error");
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        account = await signer.getAddress();
        $("walletAddr").textContent = account;

        await ensureHoodi();
        const net = await provider.getNetwork();
        $("chainName").textContent = `Hoodi Testnet (${net.chainId})`;

        const bal = await provider.getBalance(account);
        $("ethBalance").textContent = `${ethers.formatEther(bal)} ETH`;

        await loadTokens();
        await loadPools();
        await initTradeUI();
      }

      // ------------------------------ TOKEN TABLE ------------------------------
      async function loadTokens() {
        const tbody = $("tokenTable").querySelector("tbody");
        tbody.innerHTML = "";
        tokenDetails = [];

        for (const addr of TOKEN_ADDRS) {
          try {
            const c = new ethers.Contract(addr, ERC20_ABI, rpcProvider);
            const [name, symbol, decimals, balance] = await Promise.all([
              c.name(),
              c.symbol(),
              c.decimals(),
              c.balanceOf(account),
            ]);

            tokenDetails.push({ name, symbol, address: addr, decimals });
            tbody.innerHTML += `
              <tr>
                <td>${name}</td>
                <td>${symbol}</td>
                <td>${decimals}</td>
                <td>${Number(ethers.formatUnits(balance, decimals)).toFixed(
                  4
                )}</td>
                <td><a href="${HOODI.explorer}/address/${addr}" target="_blank">
                  ${addr.slice(0, 6)}...${addr.slice(-4)}</a>
                </td>
              </tr>`;
          } catch {}
        }
      }

      // ------------------------------ LIQUIDITY POOLS (formatted) ------------------------------
      async function loadPools() {
        const holder = $("poolList");
        holder.textContent = "Loadingâ€¦";

        try {
          const factory = new ethers.Contract(
            ADDR.FACTORY,
            ["function getPair(address,address) view returns (address)"],
            rpcProvider
          );

          let html = `
            <table>
              <tr>
                <th>Pair</th>
                <th>Token0</th><th>Reserve0</th>
                <th>Token1</th><th>Reserve1</th>
                <th>Price(0â†’1)</th><th>Price(1â†’0)</th>
              </tr>
          `;

          for (const token of TOKEN_ADDRS) {
            const pairAddr = await factory.getPair(token, ADDR.WETH);
            if (pairAddr === ethers.ZeroAddress) continue;

            const pair = new ethers.Contract(pairAddr, PAIR_ABI, rpcProvider);
            const [t0, t1, res] = await Promise.all([
              pair.token0(),
              pair.token1(),
              pair.getReserves(),
            ]);

            const sym0 = symbolOf(t0);
            const sym1 = symbolOf(t1);

            const r0 = Number(res[0]);
            const r1 = Number(res[1]);

            const p01 = r0 > 0 ? r1 / r0 : 0;
            const p10 = r1 > 0 ? r0 / r1 : 0;

            html += `
              <tr>
                <td><a href="${
                  HOODI.explorer
                }/address/${pairAddr}" target="_blank">${pairAddr.slice(
              0,
              10
            )}...</a></td>
                <td>${sym0}</td><td>${r0.toFixed(6)}</td>
                <td>${sym1}</td><td>${r1.toFixed(6)}</td>
                <td>${p01.toFixed(6)} ${sym0}/${sym1}</td>
                <td>${p10.toFixed(6)} ${sym1}/${sym0}</td>
              </tr>
            `;
          }

          holder.innerHTML = html + "</table>";
        } catch (err) {
          console.error(err);
          holder.textContent = "Failed to load pools.";
        }
      }

      // ------------------------------ TRADE SIMULATOR ------------------------------
      async function initTradeUI() {
        const fromSel = $("fromToken"),
          toSel = $("toToken");
        fromSel.innerHTML = "";
        toSel.innerHTML = "";

        const all = [
          { symbol: "ETH", address: "ETH", decimals: 18 },
          ...tokenDetails,
        ];

        for (const t of all) {
          const o1 = document.createElement("option");
          o1.value = t.address;
          o1.textContent = t.symbol;
          fromSel.appendChild(o1);

          const o2 = document.createElement("option");
          o2.value = t.address;
          o2.textContent = t.symbol;
          toSel.appendChild(o2);
        }
        fromSel.value = "ETH";
        if (tokenDetails[0]) toSel.value = tokenDetails[0].address;
      }

      async function getQuote() {
        try {
          const from = $("fromToken").value;
          const to = $("toToken").value;
          const amt = $("fromAmount").value;

          if (!amt || Number(amt) <= 0 || from === to) {
            return toast("Enter a valid amount and pair", "error");
          }

          const fromMeta = metaFor(from);
          const toMeta = metaFor(to);
          const path = buildPath(from, to);

          const router = new ethers.Contract(
            ADDR.ROUTER,
            ROUTER_ABI,
            rpcProvider
          );
          const amountIn = ethers.parseUnits(amt, fromMeta.decimals);
          const amounts = await router.getAmountsOut(amountIn, path);

          $("toAmount").value = ethers.formatUnits(
            amounts.at(-1),
            toMeta.decimals
          );
          toast("Quote updated", "success");
        } catch (e) {
          console.error(e);
          toast(
            "Quote failed: " + (e?.reason || e?.message || "unknown"),
            "error"
          );
        }
      }

      async function ensureApproval(token, owner, spender, amount) {
        const erc = new ethers.Contract(token, ERC20_ABI, signer);
        const current = await erc.allowance(owner, spender);
        if (current >= amount) return true;
        const tx = await erc.approve(spender, amount);
        toast("Approvingâ€¦");
        await tx.wait();
        toast("Approval confirmed", "success");
        return true;
      }

      async function executeSwap() {
        const btn = $("swapBtn");
        try {
          if (!signer) return toast("Connect wallet first", "error");
          await ensureHoodi();

          const from = $("fromToken").value;
          const to = $("toToken").value;
          const amt = $("fromAmount").value;

          if (!amt || Number(amt) <= 0 || from === to) {
            return toast("Enter valid swap details", "error");
          }

          const slipPct = Math.max(0, Number($("slippage").value || "1"));
          const deadline =
            Math.floor(Date.now() / 1000) +
            60 * Number($("deadline").value || "10");

          const fromMeta = metaFor(from);
          const toMeta = metaFor(to);
          const path = buildPath(from, to);
          const amountIn = ethers.parseUnits(amt, fromMeta.decimals);

          const router = new ethers.Contract(ADDR.ROUTER, ROUTER_ABI, signer);
          const quoted = await router.getAmountsOut(amountIn, path);
          const out = quoted.at(-1);
          const amountOutMin =
            out - (out * BigInt(Math.floor(slipPct * 100))) / 10000n;

          btn.disabled = true;
          toast("Submitting swapâ€¦");

          let tx;
          if (from === "ETH") {
            tx = await router.swapExactETHForTokens(
              amountOutMin,
              path,
              account,
              deadline,
              { value: amountIn }
            );
          } else if (to === "ETH") {
            await ensureApproval(from, account, ADDR.ROUTER, amountIn);
            tx = await router.swapExactTokensForETH(
              amountIn,
              amountOutMin,
              path,
              account,
              deadline
            );
          } else {
            await ensureApproval(from, account, ADDR.ROUTER, amountIn);
            tx = await router.swapExactTokensForTokens(
              amountIn,
              amountOutMin,
              path,
              account,
              deadline
            );
          }

          await tx.wait();
          toast("Swap successful!", "success");
          await loadTokens();
          await getQuote();
        } catch (e) {
          console.error(e);
          toast(
            "Swap failed: " + (e?.reason || e?.message || "unknown"),
            "error"
          );
        } finally {
          btn.disabled = false;
        }
      }

      // ------------------------------ BINDINGS ------------------------------
      $("connectBtn").onclick = connect;
      $("quoteBtn").onclick = getQuote;
      $("swapBtn").onclick = executeSwap;
    </script>
  </body>
</html>
